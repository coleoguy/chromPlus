---
title: "ChromePlus"
author: "Heath Blackmon"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## The model for ChromPlus

Our model builds on existing dynamic phylogenetic models of chromosome number evolution (mayrose2010, glick2014), and, like the model of zenil 2017, it incorporates a binary trait that can affect rates of chromosome number change. Additionally, our model can allow for the binary trait to affect rates of speciation and extinction. Accounting for the possibility of state dependent diversification is a vital component because of the history of speciation models that invoke chromosomal evolution (bickham1979, grant1981, templeton1981, baker1986). Our model implementation is available in an R package called chromePlus <github.com/coleoguy/chromePlus>. It is built on the diversitree framework (fitzjohn2012), which provides additional amenities such as allowing for uncertainty in the binary character state, sampling incompleteness, and use of existing MCMC (Markov Chain Monte Carlo) or likelihood maximization functions to estimate model parameters.

A graphical schematic of our model is shown in Figure 1, depicting the ten possible kinds of state transitions. While in binary state 1 a lineage with $i$ chromosomes may first simply stay in its current state. Otherwise, it may either increase chromosome number to $i+1$ (ascending dysploidy, $\lambda_1$), reduce chromosome number to $i-1$ (descending dysploidy, $\delta_1$), or increase chromosome number to $1.5i$ or $2i$ (demi-polyploidy, $\mu_1$ and polyploidy, $\rho_1$ respectively). Likewise, a lineage in binary state 2 with $i$ chromosomes may remain in its current state, increase chromosome number to $i+1$ (ascending dysploidy, $\lambda_2$), reduce chromosome number to $i-1$ (descending dysploidy, $\delta_2$), or increase chromosome number to $1.5i$ or $2i$ (demi-polyploidy, $\mu_2$ and polyploidy, $\rho_2$ respectively). Additionally, a lineage that is currently in one of the binary states can transition to the other state (transition from state 1 to state 2, $q_{12}$ or from state 2 state 1, $q_{21}$); these transitions occur with no change in the chromosome number. Because chromosome number is limited to whole numbers, demi-polyploidy as described above would only be possible for even values of $i$. As in previous work, we assume that demi-polyploidy when $i$ is odd leads to either of the closest whole numbers with equal probability. The state-dependent version of our model has four additional parameters: speciation and extinction in binary state 1, and speciation and extinction in binary state 2.

```{r,echo=F}
knitr::include_graphics("model.png", dpi=400)
```

**Figure 1 ChromePlus Model**

## Workflow

### Reading in data

The first step in the analysis is to read in our data and format it in a structure that is compatible with diversitrees make.mkn and make.musse functions.  Our package provides the datatoMatrix function to do this.

```{r}
# this is our tree
library(chromePlus)
library(diversitree)
tree <- read.tree("../inst/tree.new")

# read in your csv file with species, chromosomes, and binary character
dat1 <- read.csv("../inst/tip.data.certain.csv", as.is = T)
dat2 <- read.csv("../inst/tip.data.uncertain.csv", as.is = T)
dat.mat1 <- datatoMatrix(x     = dat1,
                         range = c(18,80),
                         hyper = T)
dat.mat2 <- datatoMatrix(x     = dat2,
                         range = c(18,80),
                         hyper = T)
```

We have read in two version of our data.  Version one each tip has an observed state with no uncertainty.  Version two has uncertainty in the state observed at the tip. This function has created a matrix where the rows are the species and the columns are all possible states.  Each species row will sum to one and the values present in the cells represent the probability that a species has a particular value. With this framework it is straight-forward to include uncertainty in observed tip values or if working with a higher level tree to represent all observed states in an unresolved clade.

### making a likelihood function

We can now use our tree and this data matrix to construct a mkn likelihood function in diversitree:

```{r}
library(diversitree)
lik1 <- make.mkn(tree = tree,
                 states = dat.mat1,
                 k = ncol(dat.mat1),
                 strict= F,
                 control=list(method="ode"))
```

The current version of make.mkn doesn't allow for uncertainty in tip states.  However, we can use the make.musse function if we have uncertainty.

```{r}
tree <- read.tree("../inst/tree.new")
library(diversitree)
lik2 <- make.musse(tree = tree,
                   states = dat.mat2,
                   k = ncol(dat.mat2),
                   strict= F,
                   control=list(method="ode"))
```

The likelihood functions that we have created have one problem.  By default all transitions between states are possible meaning that in this case we have between 15 and 16 thousand parameters in our model.  This means that we need to constrain our models to match the more biologically realistic version we have shown in figure 1.

### Constraining likelihood functions MuSSE version

We constrain our MuSSE likelihood functions using the R function `constrainMuSSE`. It has a series of arguments that allow for realistic models of chromosome evolution.  The default settings for the functions is to fit the most complex model with all possible transitions shown in figure one estimated seperately.  The table below details the arguments that can be used to simplify this full model.

Argument    |Effect
------------|------------------------------------------
hyper       |when set to `FALSE` the binary state is ignored so only a single rate of gain, loss, demiploidy, and polyploidy are possible
polyploidy  |if set to `TRUE` the the hyper state that is evaluated is polyploidy this means that transition from state 1 to state 2 in the binary character also double the chromosome number
s.lambda    |if set to `TRUE` then a single lambda (speciation rate) is estimated 
s.mu        |if set to `TRUE` then a single mu (extinction rate) is estimated
constrain   |is given a list with any of the 5 additional constraint descriptions given below
            |
drop.poly   |if set to `TRUE` then the rate of polyploidy is set to zero
drop.demi   |if set to `TRUE` then the rate of demiploidy is set to zero
symmetric   |if set to `TRUE` then the rates estimated in the two binary states are forced to be equal
nometa      |if set to `TRUE` then the binary state is ignored
meta="ARD"  |can be set to "ARD" or "SYM" to describe wether q12 and q21 are the same or different


As an example lets take are full MuSSE likelihood function created by diversitree.  Diversitree assumes no model of evolution so every transition is given a unique rate.  This leads to an enormous number of parameters in this case `r length(argnames(lik2))`.  Lets reduce this down by building a model where only increase, decrease by one, polyploidy, speciation and extinction are estimated.  All other kinds of transitions will be set to a rate of zero (e.g. no transitions from 7 chromosomes to 10).

```{r}
con.lik2 <- constrainMuSSE(data = dat.mat2,
                           lik = lik2,
                           polyploidy = F,
                           constrain = list(drop.demi = T,
                                            drop.poly= F,
                                            nometa= T))
# lets check and see what we have done by looking at the 
# parameters in are new likelihood model.
argnames(con.lik2)
```






